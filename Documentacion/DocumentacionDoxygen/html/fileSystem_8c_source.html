<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Sistema de Logging Geoposicional en Tiempo Real para Sistemas Empotrados: Fichero Fuente FS/fileSystem.c</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Sistema de Logging Geoposicional en Tiempo Real para Sistemas Empotrados
   
   </div>
   <div id="projectbrief">Trabajo Fin de Grado incluido en el proyecto Biker Assistant de la empresa SmartSoC Solutions</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generado por Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Buscar');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Página&#160;principal</span></a></li>
      <li><a href="annotated.html"><span>Estructuras&#160;de&#160;Datos</span></a></li>
      <li class="current"><a href="files.html"><span>Archivos</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Buscar" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Lista&#160;de&#160;archivos</span></a></li>
      <li><a href="globals.html"><span>Globales</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">FS/fileSystem.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="fileSystem_8c.html">Ir a la documentación de este archivo.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="fileSystem_8h.html" title="Cabecera principal del módulo del Sistema de Archivos.">fileSystem.h</a>&quot;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">static</span> <a class="code" href="structFS.html" title="Estructura que define el Sistema de Archivos.">FS</a> *fs[2];
<a name="l00008"></a>00008 <span class="keyword">static</span> <span class="keywordtype">int</span> actual_fs = 0;
<a name="l00009"></a>00009 
<a name="l00015"></a><a class="code" href="fileSystem_8c.html#a3a0f60af901aa1945ab943e63fbd06d0">00015</a> uint32_t <a class="code" href="fileSystem_8c.html#a3a0f60af901aa1945ab943e63fbd06d0" title="Convierte un dato BYTE en un dato uint32_t.">byte_2_uint32</a>(BYTE* src) {
<a name="l00016"></a>00016 
<a name="l00017"></a>00017   uint32_t dst = 0;
<a name="l00018"></a>00018   <span class="comment">/*</span>
<a name="l00019"></a>00019 <span class="comment">   dst |= (uint32_t) src[0] &lt;&lt; 0;</span>
<a name="l00020"></a>00020 <span class="comment">   dst |= (uint32_t) src[1] &lt;&lt; 8;</span>
<a name="l00021"></a>00021 <span class="comment">   dst |= (uint32_t) src[2] &lt;&lt; 16;</span>
<a name="l00022"></a>00022 <span class="comment">   dst |= (uint32_t) src[3] &lt;&lt; 24;</span>
<a name="l00023"></a>00023 <span class="comment">   */</span>
<a name="l00024"></a>00024   dst = (uint32_t) src[0] &lt;&lt; 24;
<a name="l00025"></a>00025   dst |= (uint32_t) src[1] &lt;&lt; 26;
<a name="l00026"></a>00026   dst |= (uint32_t) src[2] &lt;&lt; 8;
<a name="l00027"></a>00027   dst |= (uint32_t) src[3] &lt;&lt; 0;
<a name="l00028"></a>00028   <span class="keywordflow">return</span> dst;
<a name="l00029"></a>00029 }
<a name="l00036"></a><a class="code" href="fileSystem_8c.html#a3623bef990ae28b977811f039ee158bb">00036</a> BYTE* <a class="code" href="fileSystem_8c.html#a3623bef990ae28b977811f039ee158bb" title="Convierte un dato uint32_t en un dato BYTE.">uint32_2_byte</a>(uint32_t src, BYTE * dst) {
<a name="l00037"></a>00037   dst[3] = (BYTE) (src &gt;&gt; 24);
<a name="l00038"></a>00038   dst[2] = (BYTE) (src &gt;&gt; 16);
<a name="l00039"></a>00039   dst[1] = (BYTE) (src &gt;&gt; 8);
<a name="l00040"></a>00040   dst[0] = (BYTE) (src &gt;&gt; 0);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042   <span class="keywordflow">return</span> dst;
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00050"></a><a class="code" href="fileSystem_8c.html#aaa2cbdb65e6f30c0a2a3e5761eea1ef8">00050</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#aaa2cbdb65e6f30c0a2a3e5761eea1ef8" title="Comprueba si hay un sistema de archivos en memoria.">check_fs</a>(<span class="keywordtype">int</span> fsIndex) {
<a name="l00051"></a>00051 
<a name="l00052"></a>00052   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00053"></a>00053   BYTE check[11] = { <span class="charliteral">&#39;F&#39;</span>, <span class="charliteral">&#39;S&#39;</span>, <span class="charliteral">&#39; &#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;O&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;T&#39;</span>, <span class="charliteral">&#39;O&#39;</span> };
<a name="l00054"></a>00054   <span class="keywordtype">int</span> i;
<a name="l00055"></a>00055   result = <a class="code" href="diskio_8c.html#aa01f5479a3ee7c9aed89814238964cd2" title="Función que incializa la memoria FLASH.">disk_initialize</a>(fsIndex);
<a name="l00056"></a>00056   <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00057"></a>00057     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44cac9894bed3e8632ede8d2712235fa8e45">FR_NOT_READY</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059   result = <a class="code" href="diskio_8c.html#a9c6f716a2119a650cf3c61bee540be85" title="Función que lee datos desde la memoria FLASH.">disk_read</a>(fsIndex, fs[fsIndex]-&gt;win, 0, 1); <span class="comment">/* Read sector 0 */</span>
<a name="l00060"></a>00060   <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00061"></a>00061     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca97dee4a6b485dc8f91f37486092dfe34">FR_DISK_ERR</a>;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063   <span class="keywordflow">for</span> (i = 0; i &lt; 11; i++)
<a name="l00064"></a>00064     <span class="keywordflow">if</span> (fs[fsIndex]-&gt;win[i] != check[i])
<a name="l00065"></a>00065       <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca086154b5fee763f28c49fd0e2c1cb463">FR_NO_FILESYSTEM</a>;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00075"></a><a class="code" href="fileSystem_8c.html#a2ad7019c52d78ebe461b5ba559736aa5">00075</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a2ad7019c52d78ebe461b5ba559736aa5" title="Comprueba si el archivo es válido.">check_file</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a> *file) {
<a name="l00076"></a>00076 
<a name="l00077"></a>00077   <span class="keywordtype">int</span> i;
<a name="l00078"></a>00078   <span class="comment">/* Each file has 1 Byte validity, 4 bytes for start address, 4 bytes for end address, 7 bytes for file name */</span>
<a name="l00079"></a>00079 
<a name="l00080"></a>00080   <span class="keywordflow">if</span> (fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[0] != 255) <span class="comment">/*Invalid entry, read next*/</span>
<a name="l00081"></a>00081     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca3dec4eba481cdf5e99d7cd6009e6dcf8">FR_INVALID_OBJECT</a>; <span class="comment">/* 255 if when a byte is empty*/</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083   file-&gt;<a class="code" href="structFIL.html#a32847fe875861954ec3dc750d332a194">dirty</a> = 255;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   file-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> = fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[1] &lt;&lt; 24;
<a name="l00086"></a>00086   file-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> |= fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[2] &lt;&lt; 16;
<a name="l00087"></a>00087   file-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> |= fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[3] &lt;&lt; 8;
<a name="l00088"></a>00088   file-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> |= fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[4] &lt;&lt; 0;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   file-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> = fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[5] &lt;&lt; 24;
<a name="l00091"></a>00091   file-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> |= fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[6] &lt;&lt; 16;
<a name="l00092"></a>00092   file-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> |= fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[7] &lt;&lt; 8;
<a name="l00093"></a>00093   file-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> |= fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[8] &lt;&lt; 0;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095   file-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> = 0;
<a name="l00096"></a>00096   file-&gt;<a class="code" href="structFIL.html#ac409508881f5a16f2998ae675072b376">flag</a> = 0;
<a name="l00097"></a>00097   file-&gt;<a class="code" href="structFIL.html#aea440945db26de9c4a88065c0c887fda">err</a> = 0;
<a name="l00098"></a>00098   file-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> = 0;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   <span class="keywordflow">if</span> ((file-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> == 4294967295)
<a name="l00101"></a>00101       &amp;&amp; (file-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> == 4294967295)) { <span class="comment">/* This number is if buff is empty*/</span>
<a name="l00102"></a>00102     file-&gt;<a class="code" href="structFIL.html#aea440945db26de9c4a88065c0c887fda">err</a> = 1;
<a name="l00103"></a>00103     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c">FR_NO_FILE</a>; <span class="comment">/* No more fat entries, no more files */</span>
<a name="l00104"></a>00104   }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106   <span class="keywordflow">for</span> (i = 0; i &lt; 7; i++)
<a name="l00107"></a>00107     file-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[i] = fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[i + 9];
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00110"></a>00110 }
<a name="l00111"></a>00111 
<a name="l00118"></a><a class="code" href="fileSystem_8c.html#a4ab6badca8cdbe971b432c8a3bb7b0b1">00118</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a4ab6badca8cdbe971b432c8a3bb7b0b1" title="Lee una entrada en la tabla de descriptores de archivos y comprueba si es válida.">read_file_entry</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a> *file, DWORD sector) {
<a name="l00119"></a>00119 
<a name="l00120"></a>00120   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00121"></a>00121   result = <a class="code" href="diskio_8c.html#a9c6f716a2119a650cf3c61bee540be85" title="Función que lee datos desde la memoria FLASH.">disk_read</a>(file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>, fs[file-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>, sector, 1);
<a name="l00122"></a>00122   <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00123"></a>00123     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca97dee4a6b485dc8f91f37486092dfe34">FR_DISK_ERR</a>;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125   result = <a class="code" href="fileSystem_8c.html#a2ad7019c52d78ebe461b5ba559736aa5" title="Comprueba si el archivo es válido.">check_file</a>(file);
<a name="l00126"></a>00126   <span class="keywordflow">if</span> (result == <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00127"></a>00127     file-&gt;<a class="code" href="structFIL.html#a043930088c6fdc5e523500b833106476">descriptorSector</a> = sector;
<a name="l00128"></a>00128   <span class="keywordflow">return</span> result;
<a name="l00129"></a>00129 }
<a name="l00135"></a><a class="code" href="fileSystem_8c.html#a951ec41abe19766602d305ff1e99fd32">00135</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a951ec41abe19766602d305ff1e99fd32" title="Busca todos los archivos del sistema de archivos justo después de montarlo con éxito.">loading_files</a>(<span class="keywordtype">int</span> fsIndex) {
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00138"></a>00138   DWORD sector;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   <span class="keywordtype">int</span> nfiles = 0;
<a name="l00141"></a>00141   <span class="keywordflow">for</span> (sector = fs[fsIndex]-&gt;fatbase; sector &lt; fs[fsIndex]-&gt;<a class="code" href="structFS.html#a727068deba19f90b5b402ae005f49b58">database</a>;
<a name="l00142"></a>00142       sector++) {
<a name="l00143"></a>00143     fs[fsIndex]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[nfiles].<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a> = fsIndex;
<a name="l00144"></a>00144     result = <a class="code" href="fileSystem_8c.html#a4ab6badca8cdbe971b432c8a3bb7b0b1" title="Lee una entrada en la tabla de descriptores de archivos y comprueba si es válida.">read_file_entry</a>(&amp;fs[fsIndex]-&gt;files[nfiles], sector);
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (result == <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00146"></a>00146       nfiles++;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (result == <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c">FR_NO_FILE</a>) {
<a name="l00149"></a>00149       fs[fsIndex]-&gt;<a class="code" href="structFS.html#a050f921ab2140aa4eadce4a140b61fbe">lastDescriptor</a> = sector;
<a name="l00150"></a>00150       <span class="keywordflow">break</span>; <span class="comment">/* if no more files then is the last sector */</span>
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (nfiles == _MAX_FILES) {
<a name="l00153"></a>00153       fs[fsIndex]-&gt;<a class="code" href="structFS.html#a050f921ab2140aa4eadce4a140b61fbe">lastDescriptor</a> = sector + 1;
<a name="l00154"></a>00154       <span class="keywordflow">break</span>; <span class="comment">/* if no more files then is the last sector */</span>
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156   }
<a name="l00157"></a>00157   <span class="keywordflow">if</span> (nfiles &lt; _MAX_FILES)
<a name="l00158"></a>00158     <span class="keywordflow">for</span> (; nfiles &lt; _MAX_FILES; nfiles++) {
<a name="l00159"></a>00159       fs[fsIndex]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[nfiles].<a class="code" href="structFIL.html#aea440945db26de9c4a88065c0c887fda">err</a> = 1;
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161   <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00162"></a>00162 }
<a name="l00169"></a><a class="code" href="fileSystem_8c.html#a2c77bece2713c99a22b9ec7d1d083b47">00169</a> <span class="keywordtype">int</span> <a class="code" href="fileSystem_8c.html#a2c77bece2713c99a22b9ec7d1d083b47" title="Compara dos cadenas correspondientes al nombre de archivos.">compare</a>(<span class="keyword">const</span> TCHAR *path, TCHAR *name) {
<a name="l00170"></a>00170   <span class="keywordtype">int</span> i;
<a name="l00171"></a>00171   <span class="keywordflow">for</span> (i = 0; i &lt; 7; i++) { <span class="comment">/* 7 is the max length of name */</span>
<a name="l00172"></a>00172     <span class="keywordflow">if</span> (path[i] != name[i])
<a name="l00173"></a>00173       <span class="keywordflow">return</span> 0;
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176   <span class="keywordflow">return</span> 1;
<a name="l00177"></a>00177 }
<a name="l00184"></a><a class="code" href="fileSystem_8c.html#aa4ef3507a98f8090aa382f4015cebe78">00184</a> <span class="keywordtype">int</span> <a class="code" href="fileSystem_8c.html#aa4ef3507a98f8090aa382f4015cebe78" title="Actualiza un archivo. En la práctica crea una copia del mismo.">update_file</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a> *src, <a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a> *dst) {
<a name="l00185"></a>00185   dst-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> = src-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>;
<a name="l00186"></a>00186   dst-&gt;<a class="code" href="structFIL.html#a043930088c6fdc5e523500b833106476">descriptorSector</a> = src-&gt;<a class="code" href="structFIL.html#a043930088c6fdc5e523500b833106476">descriptorSector</a>;
<a name="l00187"></a>00187   dst-&gt;<a class="code" href="structFIL.html#a32847fe875861954ec3dc750d332a194">dirty</a> = src-&gt;<a class="code" href="structFIL.html#a32847fe875861954ec3dc750d332a194">dirty</a>;
<a name="l00188"></a>00188   dst-&gt;<a class="code" href="structFIL.html#aea440945db26de9c4a88065c0c887fda">err</a> = src-&gt;<a class="code" href="structFIL.html#aea440945db26de9c4a88065c0c887fda">err</a>;
<a name="l00189"></a>00189   dst-&gt;<a class="code" href="structFIL.html#ac409508881f5a16f2998ae675072b376">flag</a> = src-&gt;<a class="code" href="structFIL.html#ac409508881f5a16f2998ae675072b376">flag</a>;
<a name="l00190"></a>00190   dst-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> = src-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a>;
<a name="l00191"></a>00191   dst-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> = src-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a>;
<a name="l00192"></a>00192   dst-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> = src-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a>;
<a name="l00193"></a>00193   dst-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a> = src-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>;
<a name="l00194"></a>00194   <span class="keywordtype">int</span> i;
<a name="l00195"></a>00195   <span class="keywordflow">for</span> (i = 0; i &lt; 7; i++)
<a name="l00196"></a>00196     dst-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[i] = src-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[i];
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   <span class="keywordflow">return</span> 1;
<a name="l00199"></a>00199 }
<a name="l00206"></a><a class="code" href="fileSystem_8c.html#a8b7c0e2dcc69101a9bcec19d59480b0f">00206</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a8b7c0e2dcc69101a9bcec19d59480b0f" title="Copia un archivo en otro.">copy_file</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a> *src, <a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a> *dst) {
<a name="l00207"></a>00207   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00208"></a>00208   UINT byteRead = 0, byteWrite = 0;
<a name="l00209"></a>00209   <a class="code" href="fileSystem_8c.html#aefdef7126128d99d0b3bd82c28e54d80" title="Función que abre o crea un archivo.">f_open</a>(dst, (TCHAR*) src-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>, FA_OPEN_ALWAYS | FA_READ | FA_WRITE);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211   <span class="keywordflow">while</span> (src-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> &lt; src-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a>) { <span class="comment">/* ReadPointer se actualiza al leer */</span>
<a name="l00212"></a>00212     <a class="code" href="fileSystem_8c.html#ac4c3dcb6869ca252888eebabe39727b3" title="Función que lee de un archivo.">f_read</a>(src, fs[src-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>, SECTOR_SIZE, &amp;byteRead);
<a name="l00213"></a>00213     <a class="code" href="fileSystem_8c.html#ae6a4dfae8a9e308bdb2283a37ef680f2" title="Función que escribe de un archivo.">f_write</a>(dst, fs[src-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>, byteRead, &amp;byteWrite);
<a name="l00214"></a>00214   }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <a class="code" href="fileSystem_8c.html#a53882db20ef4323dcfd1874d7733ffc3" title="Función que cierra un archivo.">f_close</a>(src);
<a name="l00217"></a>00217   <a class="code" href="fileSystem_8c.html#a53882db20ef4323dcfd1874d7733ffc3" title="Función que cierra un archivo.">f_close</a>(dst);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219   <span class="keywordflow">return</span> result;
<a name="l00220"></a>00220 }
<a name="l00227"></a><a class="code" href="fileSystem_8c.html#ac1802ff989bc875c1147d22cf93e8416">00227</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#ac1802ff989bc875c1147d22cf93e8416" title="Crea una copia del sistema de archivos en otro sistema de archivos.">backup_fs</a>(<span class="keywordtype">int</span> src, <span class="keywordtype">int</span> dst) {
<a name="l00228"></a>00228   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00229"></a>00229   <span class="keywordtype">int</span> i;
<a name="l00230"></a>00230   <span class="keywordflow">for</span> (i = 0; i &lt; _MAX_FILES; i++) {
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (fs[src]-&gt;files[i].err == -1)
<a name="l00232"></a>00232       <span class="keywordflow">break</span>;
<a name="l00233"></a>00233     result = <a class="code" href="fileSystem_8c.html#a8b7c0e2dcc69101a9bcec19d59480b0f" title="Copia un archivo en otro.">copy_file</a>(&amp;fs[src]-&gt;files[i], &amp;fs[dst]-&gt;files[i]);
<a name="l00234"></a>00234     <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00235"></a>00235       <span class="keywordflow">return</span> result;
<a name="l00236"></a>00236   }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   <span class="keywordflow">return</span> result;
<a name="l00239"></a>00239 }
<a name="l00244"></a><a class="code" href="fileSystem_8c.html#a7211e2f1543fb9aabc61814f9fb89546">00244</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a7211e2f1543fb9aabc61814f9fb89546" title="Cierra todos los archivos del sistema de archivos actual.">close_all_files</a>() {
<a name="l00245"></a>00245   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00246"></a>00246   <span class="keywordtype">int</span> i;
<a name="l00247"></a>00247   <span class="keywordflow">for</span> (i = 0; i &lt; _MAX_FILES; i++)
<a name="l00248"></a>00248     <span class="keywordflow">if</span> (fs[actual_fs]-&gt;files[i].err == 0)
<a name="l00249"></a>00249       <a class="code" href="fileSystem_8c.html#a53882db20ef4323dcfd1874d7733ffc3" title="Función que cierra un archivo.">f_close</a>(&amp;fs[actual_fs]-&gt;files[i]);
<a name="l00250"></a>00250   <span class="keywordflow">return</span> result;
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="fileSystem_8h.html#afcfe716c836b3b8a019fa38faf56da96">00253</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#afcfe716c836b3b8a019fa38faf56da96" title="Función que resetea un sector.">reset_sector</a>(<span class="keywordtype">int</span> fsIndex) {
<a name="l00254"></a>00254   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00255"></a>00255   uint32_t address;
<a name="l00256"></a>00256   <span class="keywordflow">if</span> (fsIndex == 0)
<a name="l00257"></a>00257     address = PHYSYCAL_START_ADDRESS;
<a name="l00258"></a>00258   <span class="keywordflow">else</span>
<a name="l00259"></a>00259     address = PHYSYCAL_START_ADDRESS2;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   result = <a class="code" href="diskio_8c.html#a816bffc54e390c15d03f477133707de5" title="Función de control de entrada/salida, varias funciones.">disk_ioctl</a>(fsIndex, CTRL_ERASE_SECTOR, (<span class="keywordtype">void</span> *) address);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263   <span class="keywordflow">return</span> result;
<a name="l00264"></a>00264 }
<a name="l00265"></a>00265 
<a name="l00266"></a><a class="code" href="fileSystem_8h.html#a5df0ac672ada972e89ef4b003e57f964">00266</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a5df0ac672ada972e89ef4b003e57f964" title="Función que mueve el puntero de lectura de un archivo.">f_lseek</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a>* fp, DWORD ofs) {
<a name="l00267"></a>00267   <span class="keywordflow">if</span> (fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> + ofs &lt; fp-&gt;writePointer)
<a name="l00268"></a>00268     fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> += ofs;
<a name="l00269"></a>00269   <span class="keywordflow">else</span>
<a name="l00270"></a>00270     fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> = fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> - 4;
<a name="l00271"></a>00271   <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00279"></a><a class="code" href="fileSystem_8c.html#a517b0da489a13124534a5eebc7af5358">00279</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a517b0da489a13124534a5eebc7af5358" title="Cambia el sector físico por defecto en el que se crea el sistema de archivos.">change_sector</a>(<span class="keywordtype">int</span> opt) {
<a name="l00280"></a>00280   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00281"></a>00281   <a class="code" href="structFS.html" title="Estructura que define el Sistema de Archivos.">FS</a> fs1, fs2;
<a name="l00282"></a>00282   <span class="keywordflow">if</span> (actual_fs == 0) {
<a name="l00283"></a>00283     <a class="code" href="fileSystem_8c.html#afcfe716c836b3b8a019fa38faf56da96" title="Función que resetea un sector.">reset_sector</a>(1);
<a name="l00284"></a>00284     <a class="code" href="fileSystem_8c.html#a06b1816d729a1ee702209d4ddc1d91af" title="Función que crea la estructura necesaria para crear un sistema de archivos.">f_mount</a>(&amp;fs1, 1, 0);
<a name="l00285"></a>00285     <a class="code" href="fileSystem_8c.html#a8e75c990b2a6c64fa783c75aace55059" title="Función que crea un sistema de archivos.">f_mkfs</a>(1);
<a name="l00286"></a>00286     <a class="code" href="fileSystem_8c.html#a06b1816d729a1ee702209d4ddc1d91af" title="Función que crea la estructura necesaria para crear un sistema de archivos.">f_mount</a>(&amp;fs1, 1, 1);
<a name="l00287"></a>00287     <a class="code" href="fileSystem_8c.html#a06b1816d729a1ee702209d4ddc1d91af" title="Función que crea la estructura necesaria para crear un sistema de archivos.">f_mount</a>(&amp;fs2, 0, 1);
<a name="l00288"></a>00288     actual_fs = 1;
<a name="l00289"></a>00289     <span class="keywordflow">if</span> (opt == 1)
<a name="l00290"></a>00290       result = <a class="code" href="fileSystem_8c.html#ac1802ff989bc875c1147d22cf93e8416" title="Crea una copia del sistema de archivos en otro sistema de archivos.">backup_fs</a>(0, 1);
<a name="l00291"></a>00291   } <span class="keywordflow">else</span> {
<a name="l00292"></a>00292     <a class="code" href="fileSystem_8c.html#afcfe716c836b3b8a019fa38faf56da96" title="Función que resetea un sector.">reset_sector</a>(0);
<a name="l00293"></a>00293     <a class="code" href="fileSystem_8c.html#a06b1816d729a1ee702209d4ddc1d91af" title="Función que crea la estructura necesaria para crear un sistema de archivos.">f_mount</a>(&amp;fs1, 0, 0);
<a name="l00294"></a>00294     <a class="code" href="fileSystem_8c.html#a8e75c990b2a6c64fa783c75aace55059" title="Función que crea un sistema de archivos.">f_mkfs</a>(0);
<a name="l00295"></a>00295     <a class="code" href="fileSystem_8c.html#a06b1816d729a1ee702209d4ddc1d91af" title="Función que crea la estructura necesaria para crear un sistema de archivos.">f_mount</a>(&amp;fs1, 0, 1);
<a name="l00296"></a>00296     <a class="code" href="fileSystem_8c.html#a06b1816d729a1ee702209d4ddc1d91af" title="Función que crea la estructura necesaria para crear un sistema de archivos.">f_mount</a>(&amp;fs2, 1, 1);
<a name="l00297"></a>00297     actual_fs = 0;
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (opt == 1)
<a name="l00299"></a>00299       result = <a class="code" href="fileSystem_8c.html#ac1802ff989bc875c1147d22cf93e8416" title="Crea una copia del sistema de archivos en otro sistema de archivos.">backup_fs</a>(1, 0);
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301   <span class="keywordflow">return</span> result;
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="comment">/* Open or create a file */</span>
<a name="l00305"></a><a class="code" href="fileSystem_8h.html#aefdef7126128d99d0b3bd82c28e54d80">00305</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#aefdef7126128d99d0b3bd82c28e54d80" title="Función que abre o crea un archivo.">f_open</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a>* fp, <span class="comment">/* Pointer to the blank file object */</span>
<a name="l00306"></a>00306 <span class="keyword">const</span> TCHAR* path, <span class="comment">/* Pointer to the file name */</span>
<a name="l00307"></a>00307 BYTE mode <span class="comment">/* Access mode and file open mode flags */</span>
<a name="l00308"></a>00308 ) {
<a name="l00309"></a>00309   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00310"></a>00310   <span class="keywordtype">int</span> i, j;
<a name="l00311"></a>00311   <span class="keywordtype">int</span> find = 0;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313   <span class="keywordflow">if</span> (!fp)
<a name="l00314"></a>00314     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca3dec4eba481cdf5e99d7cd6009e6dcf8">FR_INVALID_OBJECT</a>;
<a name="l00315"></a>00315   mode &amp;= FA_READ | FA_WRITE | FA_CREATE_ALWAYS | FA_OPEN_ALWAYS
<a name="l00316"></a>00316       | FA_CREATE_NEW;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318   <span class="keywordflow">for</span> (i = 0; i &lt; _MAX_FILES &amp;&amp; find == 0; i++) {
<a name="l00319"></a>00319     <span class="keywordflow">if</span> (fs[actual_fs]-&gt;files[i].err == 1)
<a name="l00320"></a>00320       <span class="keywordflow">break</span>;
<a name="l00321"></a>00321     <span class="keywordflow">if</span> (<a class="code" href="fileSystem_8c.html#a2c77bece2713c99a22b9ec7d1d083b47" title="Compara dos cadenas correspondientes al nombre de archivos.">compare</a>(path, (TCHAR*) fs[actual_fs]-&gt;files[i].name) == 1) {
<a name="l00322"></a>00322       fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#ac409508881f5a16f2998ae675072b376">flag</a> = mode;
<a name="l00323"></a>00323       find = 1;
<a name="l00324"></a>00324       <span class="keywordflow">break</span>;
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326   }
<a name="l00327"></a>00327   <span class="keywordflow">if</span> (i == _MAX_FILES &amp;&amp; find == 0)
<a name="l00328"></a>00328     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44cac7926e01d7519a1a7e21a44e2dd76789">FR_TOO_MANY_FILES</a>;
<a name="l00329"></a>00329   <span class="keywordflow">if</span> (find == 0
<a name="l00330"></a>00330       &amp;&amp; (mode &amp; (FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW))) {
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="keywordflow">for</span> (j = 0; j &lt; 7; j++) {
<a name="l00333"></a>00333       fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[j] = (BYTE) path[j];
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a32847fe875861954ec3dc750d332a194">dirty</a> = 1; <span class="comment">/* Created is dirty */</span>
<a name="l00336"></a>00336     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#ac409508881f5a16f2998ae675072b376">flag</a> = mode;
<a name="l00337"></a>00337     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a> = actual_fs;
<a name="l00338"></a>00338     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> = fs[actual_fs]-&gt;<a class="code" href="structFS.html#a727068deba19f90b5b402ae005f49b58">database</a> * (i + 1);
<a name="l00339"></a>00339     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> = 0;
<a name="l00340"></a>00340     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> = 0;
<a name="l00341"></a>00341     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#aea440945db26de9c4a88065c0c887fda">err</a> = 0;
<a name="l00342"></a>00342     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> = 0;
<a name="l00343"></a>00343     fs[actual_fs]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a043930088c6fdc5e523500b833106476">descriptorSector</a> = 0;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (find == 0)
<a name="l00346"></a>00346     result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c">FR_NO_FILE</a>;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348   <a class="code" href="fileSystem_8c.html#aa4ef3507a98f8090aa382f4015cebe78" title="Actualiza un archivo. En la práctica crea una copia del mismo.">update_file</a>(&amp;fs[actual_fs]-&gt;files[i], fp);
<a name="l00349"></a>00349   <span class="keywordflow">return</span> result;
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="comment">/* Close an open file object */</span>
<a name="l00353"></a><a class="code" href="fileSystem_8h.html#a53882db20ef4323dcfd1874d7733ffc3">00353</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a53882db20ef4323dcfd1874d7733ffc3" title="Función que cierra un archivo.">f_close</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a> *fp <span class="comment">/* Pointer to the file object to be closed */</span>) {
<a name="l00354"></a>00354   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> res = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00355"></a>00355   <span class="keywordflow">if</span> (fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> != 0) {
<a name="l00356"></a>00356     <a class="code" href="fileSystem_8c.html#ad69c7246b122ba56a134939ee0eaf847" title="Función que sincroniza un archivo, escribe en memoria los datos que queden pendientes.">f_sync</a>(fp);
<a name="l00357"></a>00357   }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359   <span class="keywordflow">if</span> (fp-&gt;<a class="code" href="structFIL.html#a32847fe875861954ec3dc750d332a194">dirty</a> != 255) {
<a name="l00360"></a>00360     <span class="keywordflow">if</span> (fp-&gt;<a class="code" href="structFIL.html#a043930088c6fdc5e523500b833106476">descriptorSector</a> != 0) { <span class="comment">/* Si es 0 quiere decir que no tiene ningun descriptor */</span>
<a name="l00361"></a>00361       fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[0] = 0; <span class="comment">/* Para ponerlo como invalido*/</span>
<a name="l00362"></a>00362       <a class="code" href="diskio_8c.html#a4fc55609dc0b2fba35c679984ae7ca68" title="Función que escribe en la memoria FLASH.">disk_write</a>(fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>, fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>, fp-&gt;<a class="code" href="structFIL.html#a043930088c6fdc5e523500b833106476">descriptorSector</a>,
<a name="l00363"></a>00363           1);
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[0] = 255;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[1] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> &gt;&gt; 24);
<a name="l00369"></a>00369     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[2] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> &gt;&gt; 16);
<a name="l00370"></a>00370     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[3] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> &gt;&gt; 8);
<a name="l00371"></a>00371     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[4] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> &gt;&gt; 0);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[5] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> &gt;&gt; 24);
<a name="l00374"></a>00374     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[6] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> &gt;&gt; 16);
<a name="l00375"></a>00375     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[7] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> &gt;&gt; 8);
<a name="l00376"></a>00376     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[8] = (BYTE) (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> &gt;&gt; 0);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[9] = fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[0];
<a name="l00379"></a>00379     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[10] = fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[1];
<a name="l00380"></a>00380     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[11] = fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[2];
<a name="l00381"></a>00381     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[12] = fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[3];
<a name="l00382"></a>00382     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[13] = fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[4];
<a name="l00383"></a>00383     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[14] = fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[5];
<a name="l00384"></a>00384     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[15] = fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>[6];
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     fp-&gt;<a class="code" href="structFIL.html#a043930088c6fdc5e523500b833106476">descriptorSector</a> = fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a050f921ab2140aa4eadce4a140b61fbe">lastDescriptor</a>;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <a class="code" href="diskio_8c.html#a4fc55609dc0b2fba35c679984ae7ca68" title="Función que escribe en la memoria FLASH.">disk_write</a>(fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>, fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>, fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a050f921ab2140aa4eadce4a140b61fbe">lastDescriptor</a>++, 1); <span class="comment">// lastDescriptor is the number of sector</span>
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     fp-&gt;<a class="code" href="structFIL.html#a32847fe875861954ec3dc750d332a194">dirty</a> = 255;
<a name="l00391"></a>00391   }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="keywordtype">int</span> i;
<a name="l00394"></a>00394   <span class="keywordflow">for</span> (i = 0; i &lt; _MAX_FILES; i++) {
<a name="l00395"></a>00395     <span class="keywordflow">if</span> (<a class="code" href="fileSystem_8c.html#a2c77bece2713c99a22b9ec7d1d083b47" title="Compara dos cadenas correspondientes al nombre de archivos.">compare</a>((TCHAR*) fp-&gt;<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>, (TCHAR*) fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a21240fe08417eb46f794e67519bf4a58">name</a>)
<a name="l00396"></a>00396         == 1)
<a name="l00397"></a>00397       <span class="keywordflow">break</span>;
<a name="l00398"></a>00398   }
<a name="l00399"></a>00399   <a class="code" href="fileSystem_8c.html#aa4ef3507a98f8090aa382f4015cebe78" title="Actualiza un archivo. En la práctica crea una copia del mismo.">update_file</a>(fp, &amp;fs[actual_fs]-&gt;files[i]);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401   <span class="keywordflow">return</span> res;
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">/* Read data from a file */</span>
<a name="l00405"></a><a class="code" href="fileSystem_8h.html#ac4c3dcb6869ca252888eebabe39727b3">00405</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#ac4c3dcb6869ca252888eebabe39727b3" title="Función que lee de un archivo.">f_read</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a>* fp, <span class="comment">/* Pointer to the file object */</span>
<a name="l00406"></a>00406 <span class="keywordtype">void</span>* buff, <span class="comment">/* Pointer to data buffer */</span>
<a name="l00407"></a>00407 UINT btr, <span class="comment">/* Number of bytes to read */</span>
<a name="l00408"></a>00408 UINT* br <span class="comment">/* Pointer to number of bytes read */</span>
<a name="l00409"></a>00409 ) {
<a name="l00410"></a>00410   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00411"></a>00411   BYTE *rbuff = (BYTE*) buff;
<a name="l00412"></a>00412   <span class="keywordflow">if</span> (((fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> + fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>) - fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a>) &lt; btr)
<a name="l00413"></a>00413     btr = (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> + fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>) - fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a>;
<a name="l00414"></a>00414   <span class="keywordtype">int</span> sector = fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> + (fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> / SECTOR_SIZE);
<a name="l00415"></a>00415   <span class="keywordtype">int</span> offset = fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> % SECTOR_SIZE;
<a name="l00416"></a>00416   UINT counter = 0;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <span class="keywordflow">while</span> (counter &lt; btr) {
<a name="l00419"></a>00419     <a class="code" href="diskio_8c.html#a9c6f716a2119a650cf3c61bee540be85" title="Función que lee datos desde la memoria FLASH.">disk_read</a>(fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>, fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>, sector++, 1);
<a name="l00420"></a>00420     <span class="keywordflow">while</span> (offset &lt; SECTOR_SIZE) {
<a name="l00421"></a>00421       rbuff[counter++] = fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[offset++];
<a name="l00422"></a>00422       <span class="keywordflow">if</span> (counter == btr) {
<a name="l00423"></a>00423         fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> += counter;
<a name="l00424"></a>00424         *br = counter;
<a name="l00425"></a>00425         <span class="keywordflow">break</span>;
<a name="l00426"></a>00426       }
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     offset = 0;
<a name="l00429"></a>00429   }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   <span class="keywordflow">return</span> result;
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="comment">/* Write data to a file */</span>
<a name="l00435"></a><a class="code" href="fileSystem_8h.html#ae6a4dfae8a9e308bdb2283a37ef680f2">00435</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#ae6a4dfae8a9e308bdb2283a37ef680f2" title="Función que escribe de un archivo.">f_write</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a>* fp, <span class="comment">/* Pointer to the file object */</span>
<a name="l00436"></a>00436 <span class="keyword">const</span> <span class="keywordtype">void</span> *buff, <span class="comment">/* Pointer to the data to be written */</span>
<a name="l00437"></a>00437 UINT btw, <span class="comment">/* Number of bytes to write */</span>
<a name="l00438"></a>00438 UINT* bw <span class="comment">/* Pointer to number of bytes written */</span>
<a name="l00439"></a>00439 ) {
<a name="l00440"></a>00440   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00441"></a>00441   BYTE *rbuff = (BYTE*) buff;
<a name="l00442"></a>00442   fp-&gt;<a class="code" href="structFIL.html#a32847fe875861954ec3dc750d332a194">dirty</a> = 1;
<a name="l00443"></a>00443   DWORD sector = fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> + (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> / SECTOR_SIZE);
<a name="l00444"></a>00444   <span class="keywordtype">int</span> index = 0, offset;
<a name="l00445"></a>00445   offset = fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> % SECTOR_SIZE;
<a name="l00446"></a>00446   <span class="comment">/* Quiere decir que el ultimo sector escrito no esta completo.</span>
<a name="l00447"></a>00447 <span class="comment">   * Si buffindex no es 0 esto ya se ha comprobado antes.</span>
<a name="l00448"></a>00448 <span class="comment">   * Puede haber offset!=0 y buffindex!=0 cuando aun no hay suficiente para escribir un sector */</span>
<a name="l00449"></a>00449   <span class="keywordflow">if</span> (offset != 0 &amp;&amp; fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> == 0) {
<a name="l00450"></a>00450     <a class="code" href="diskio_8c.html#a9c6f716a2119a650cf3c61bee540be85" title="Función que lee datos desde la memoria FLASH.">disk_read</a>(fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>, fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>, sector, 1);
<a name="l00451"></a>00451     <span class="keywordflow">for</span> (; fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> &lt; SECTOR_SIZE; fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>++) {
<a name="l00452"></a>00452       <span class="keywordflow">if</span> (fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>] == 255)
<a name="l00453"></a>00453         <span class="keywordflow">break</span>;
<a name="l00454"></a>00454       fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>] = fs[fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>];
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456     fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> -= offset;
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459   <span class="keywordflow">while</span> (index &lt; btw) {
<a name="l00460"></a>00460     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>++] = rbuff[index++];
<a name="l00461"></a>00461     <span class="keywordflow">if</span> (fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> == SECTOR_SIZE) {
<a name="l00462"></a>00462       fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> = 0;
<a name="l00463"></a>00463       <a class="code" href="diskio_8c.html#a4fc55609dc0b2fba35c679984ae7ca68" title="Función que escribe en la memoria FLASH.">disk_write</a>(fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>, fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>, sector++, 1);
<a name="l00464"></a>00464       fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> += 16;
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466   }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   *bw = btw;
<a name="l00469"></a>00469   <span class="keywordflow">return</span> result;
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 <span class="comment">/* Move file pointer of a file object */</span>
<a name="l00473"></a><a class="code" href="fileSystem_8h.html#acdcf7b6e3f54419d2612c38f83733edf">00473</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#acdcf7b6e3f54419d2612c38f83733edf" title="Función que elimina parte de un archivo.">f_truncateStart</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a>* fp, <span class="comment">/* Pointer to the file object */</span>
<a name="l00474"></a>00474 DWORD ofs <span class="comment">/* File pointer from top of file */</span>
<a name="l00475"></a>00475 ) {
<a name="l00476"></a>00476   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> += ofs;
<a name="l00479"></a>00479   fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> -= ofs;
<a name="l00480"></a>00480   <span class="keywordflow">if</span> (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> &lt; 0)
<a name="l00481"></a>00481     fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> = 0;
<a name="l00482"></a>00482   fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> -= ofs;
<a name="l00483"></a>00483   <span class="keywordflow">if</span> (fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> &lt; 0)
<a name="l00484"></a>00484     fp-&gt;<a class="code" href="structFIL.html#ad0d1f48655e0e06936cb7883993afb1f">readPointer</a> = 0;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486   <span class="keywordflow">return</span> result;
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 <span class="comment">/* Flush cached data of a writing file */</span>
<a name="l00490"></a><a class="code" href="fileSystem_8h.html#ad69c7246b122ba56a134939ee0eaf847">00490</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#ad69c7246b122ba56a134939ee0eaf847" title="Función que sincroniza un archivo, escribe en memoria los datos que queden pendientes.">f_sync</a>(<a class="code" href="structFIL.html" title="Estructura que define un archivo.">FIL</a>* fp <span class="comment">/* Pointer to the file object */</span>
<a name="l00491"></a>00491 ) {
<a name="l00492"></a>00492   DRESULT result;
<a name="l00493"></a>00493   DWORD sector = fp-&gt;<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a> + (fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> / SECTOR_SIZE);
<a name="l00494"></a>00494   fp-&gt;<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a> += fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>;
<a name="l00495"></a>00495   <span class="keywordflow">for</span> (; fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> &lt; SECTOR_SIZE; fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>++)
<a name="l00496"></a>00496     fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>[fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a>] = 255;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   fp-&gt;<a class="code" href="structFIL.html#a5fb6271e3cc261b9f811bb8860cb6110">buffindex</a> = 0;
<a name="l00499"></a>00499   result = <a class="code" href="diskio_8c.html#a4fc55609dc0b2fba35c679984ae7ca68" title="Función que escribe en la memoria FLASH.">disk_write</a>(fp-&gt;<a class="code" href="structFIL.html#ab32bf8d0b478b2cef4942b2128f4f5f5">fsIndex</a>, fp-&gt;<a class="code" href="structFIL.html#a9e1f6c5e0e2cd4fd3705e5a213ad2f83">buff</a>, sector, 1);
<a name="l00500"></a>00500   <span class="keywordflow">return</span> result;
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="comment">/* Get min free space for a file */</span>
<a name="l00504"></a><a class="code" href="fileSystem_8h.html#ad34712146dce899b62634cbc071ff5b1">00504</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a08c2cfaf5d5cde77fc6853ab7a11dd8a" title="Función que devuelve el número de sectores libres del sistema de archivos.">f_getfree</a>(<span class="keywordtype">int</span> fsIndex, <span class="comment">/*Index of fileSystem */</span>
<a name="l00505"></a>00505 UINT* mnfs <span class="comment">/* Pointer to a variable to return number of free sectors */</span>
<a name="l00506"></a>00506 ) {
<a name="l00507"></a>00507   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00508"></a>00508   <span class="keywordtype">int</span> i, minFreeSectors = 0, freeSectors = 0;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   minFreeSectors = MAX_FILE_SIZE - fs[fsIndex]-&gt;<a class="code" href="structFS.html#a050f921ab2140aa4eadce4a140b61fbe">lastDescriptor</a>;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512   <span class="keywordflow">for</span> (i = 0; i &lt; _MAX_FILES; i++) {
<a name="l00513"></a>00513     <span class="keywordflow">if</span> (fs[fsIndex]-&gt;files[i].err != -1) {
<a name="l00514"></a>00514       <span class="comment">/* i+2 porque se contempla el tamaño de un archivo extra para descriptores del FS */</span>
<a name="l00515"></a>00515       freeSectors =
<a name="l00516"></a>00516           (MAX_FILE_SIZE * (i + 2))
<a name="l00517"></a>00517               - ((fs[fsIndex]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a684d4d555f293b08b8396c35e20706d3">startSector</a>
<a name="l00518"></a>00518                   + fs[fsIndex]-&gt;<a class="code" href="structFS.html#a5772298ea6aafc77f842037933531a02">files</a>[i].<a class="code" href="structFIL.html#a89e92b4845c72b4f9f119b38d1142a41">writePointer</a>)
<a name="l00519"></a>00519                   / SECTOR_SIZE);
<a name="l00520"></a>00520       <span class="keywordflow">if</span> (freeSectors &lt; minFreeSectors)
<a name="l00521"></a>00521         minFreeSectors = freeSectors;
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523   }
<a name="l00524"></a>00524   mnfs = (UINT*) minFreeSectors;
<a name="l00525"></a>00525   <span class="keywordflow">return</span> result;
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="comment">/* Mount/Unmount a logical drive */</span>
<a name="l00529"></a><a class="code" href="fileSystem_8h.html#a06b1816d729a1ee702209d4ddc1d91af">00529</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a06b1816d729a1ee702209d4ddc1d91af" title="Función que crea la estructura necesaria para crear un sistema de archivos.">f_mount</a>(<a class="code" href="structFS.html" title="Estructura que define el Sistema de Archivos.">FS</a> * fileSystem, <span class="keywordtype">int</span> fsIndex, <span class="comment">/*Index of fileSystem */</span>
<a name="l00530"></a>00530 BYTE opt <span class="comment">/* 0:Do not mount (delayed mount), 1:Mount immediately */</span>
<a name="l00531"></a>00531 ) {
<a name="l00532"></a>00532   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00533"></a>00533   fs[fsIndex] = fileSystem;
<a name="l00534"></a>00534   <span class="keywordflow">if</span> (fsIndex == 0)
<a name="l00535"></a>00535     fileSystem-&gt;<a class="code" href="structFS.html#a22eed025311346b8029d8b445c192b95">start_address</a> = PHYSYCAL_START_ADDRESS;
<a name="l00536"></a>00536   <span class="keywordflow">else</span>
<a name="l00537"></a>00537     fileSystem-&gt;<a class="code" href="structFS.html#a22eed025311346b8029d8b445c192b95">start_address</a> = PHYSYCAL_START_ADDRESS2;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539   fileSystem-&gt;<a class="code" href="structFS.html#a06559d64af1c2b15af05165f30c59868">sector_size</a> = SECTOR_SIZE;
<a name="l00540"></a>00540   fileSystem-&gt;<a class="code" href="structFS.html#ab8f2ed716ba1865bff2fe82d36e90546">fs_size</a> = FS_SIZE;
<a name="l00541"></a>00541   fileSystem-&gt;<a class="code" href="structFS.html#adae8dcbe72b934a870bf663481207e3e">free_sector</a> = FS_SIZE;
<a name="l00542"></a>00542   fileSystem-&gt;<a class="code" href="structFS.html#a6b431a5035eb3bb668565772a3ecd57a">volbase</a> = 0;
<a name="l00543"></a>00543   fileSystem-&gt;<a class="code" href="structFS.html#a7c6676234fc0734f2139c627a0b01428">fatbase</a> = 2; <span class="comment">/* Because only need 1 sector for FS info */</span>
<a name="l00544"></a>00544   fileSystem-&gt;<a class="code" href="structFS.html#a727068deba19f90b5b402ae005f49b58">database</a> = FS_SIZE / (_MAX_FILES + 1); <span class="comment">/* Same size for fs info than file data*/</span>
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   <span class="keywordflow">if</span> (opt != 1)
<a name="l00547"></a>00547     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549   result = <a class="code" href="fileSystem_8c.html#aaa2cbdb65e6f30c0a2a3e5761eea1ef8" title="Comprueba si hay un sistema de archivos en memoria.">check_fs</a>(fsIndex);
<a name="l00550"></a>00550   <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00551"></a>00551     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca086154b5fee763f28c49fd0e2c1cb463">FR_NO_FILESYSTEM</a>;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553   result = <a class="code" href="fileSystem_8c.html#a951ec41abe19766602d305ff1e99fd32" title="Busca todos los archivos del sistema de archivos justo después de montarlo con éxito.">loading_files</a>(fsIndex);
<a name="l00554"></a>00554   <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00555"></a>00555     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c">FR_NO_FILE</a>;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557   <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="comment">/* Create a file system on the volume */</span>
<a name="l00561"></a><a class="code" href="fileSystem_8h.html#a8e75c990b2a6c64fa783c75aace55059">00561</a> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> <a class="code" href="fileSystem_8c.html#a8e75c990b2a6c64fa783c75aace55059" title="Función que crea un sistema de archivos.">f_mkfs</a>(<span class="keywordtype">int</span> fsIndex<span class="comment">/*Index of fileSystem */</span>) {
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44c" title="Enumeración de los estados de operación de la memoria FLASH.">FRESULT</a> result = <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00564"></a>00564   BYTE buff[SECTOR_SIZE] = { <span class="charliteral">&#39;F&#39;</span>, <span class="charliteral">&#39;S&#39;</span>, <span class="charliteral">&#39; &#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;O&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;T&#39;</span>,
<a name="l00565"></a>00565       <span class="charliteral">&#39;O&#39;</span> };
<a name="l00566"></a>00566 
<a name="l00567"></a>00567   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[0] = buff[0];
<a name="l00568"></a>00568   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[1] = buff[1];
<a name="l00569"></a>00569   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[2] = buff[2];
<a name="l00570"></a>00570   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[3] = buff[3];
<a name="l00571"></a>00571   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[4] = buff[4];
<a name="l00572"></a>00572   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[5] = buff[5];
<a name="l00573"></a>00573   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[6] = buff[6];
<a name="l00574"></a>00574   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[7] = buff[7];
<a name="l00575"></a>00575   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[8] = buff[8];
<a name="l00576"></a>00576   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[9] = buff[9];
<a name="l00577"></a>00577   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[10] = buff[10];
<a name="l00578"></a>00578   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[11] = buff[11];
<a name="l00579"></a>00579   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[12] = buff[12];
<a name="l00580"></a>00580   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[13] = buff[13];
<a name="l00581"></a>00581   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[14] = buff[14];
<a name="l00582"></a>00582   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[15] = buff[15];
<a name="l00583"></a>00583   fs[fsIndex]-&gt;<a class="code" href="structFS.html#a23d4e26f31e8932d8b216955e6af2130">win</a>[16] = buff[16];
<a name="l00584"></a>00584 
<a name="l00585"></a>00585   result = <a class="code" href="diskio_8c.html#aa01f5479a3ee7c9aed89814238964cd2" title="Función que incializa la memoria FLASH.">disk_initialize</a>(fsIndex);
<a name="l00586"></a>00586   <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00587"></a>00587     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44cac9894bed3e8632ede8d2712235fa8e45">FR_NOT_READY</a>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589   result = <a class="code" href="diskio_8c.html#a4fc55609dc0b2fba35c679984ae7ca68" title="Función que escribe en la memoria FLASH.">disk_write</a>(fsIndex, fs[fsIndex]-&gt;win, 0, 1);
<a name="l00590"></a>00590   <span class="keywordflow">if</span> (result != <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>)
<a name="l00591"></a>00591     <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca97dee4a6b485dc8f91f37486092dfe34">FR_DISK_ERR</a>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593   <span class="keywordflow">return</span> <a class="code" href="fileSystem_8h.html#a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1">FR_OK</a>;
<a name="l00594"></a>00594 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>Todo</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Estructuras de Datos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Archivos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Funciones</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>&apos;typedefs&apos;</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumeraciones</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Valores de enumeraciones</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generado el Miércoles, 2 de Julio de 2014 10:04:37 para Sistema de Logging Geoposicional en Tiempo Real para Sistemas Empotrados por &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
